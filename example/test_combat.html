<link rel="stylesheet" type="text/css" href="/src/css/animate.css"></link>
<link rel="stylesheet" type="text/css" href="/src/css/rpgn.css"></link>
<script type="module">
import {assets} from '/src/assets.js';
import {Game} from '/src/game.js';
import {Character, Player} from '/src/characters.js';
import {Left, Right, Center} from '/src/positions.js'
import * as ui from '/src/ui.js';
import {Scene} from '/src/ui.js';
import * as Text from '/src/text.js';
import * as Combat from '/src/combat.js';

var Sonic = Character.from_obj({
  name: 'Sonic',
  color: 'blue',
  assets: {
    images: {
      base_path: './assets/sonic',
      'default': 'sonic.png',
    },
  },
});
var s = Sonic.renderer;

var Me = new Player('Me', 'green');
var me = Me.renderer;

var game = new Game(Me);

window.Types = new Combat.MoveTypes({
  'fighting': {
    advantage: ['magic'],
  },
  'magic': {
    advantage: ['fighting'],
    disadvantage: [['magic', 2]],
  }
});

class ExampleMove extends Combat.Move {
  constructor(user, types) {
    super(types, null);
    this.user = user;
    this.fight_level = this.types.has('fighting') ? 1 : 0;
    this.magic_level = this.types.has('magic') ? 1 : 0;
  }

  level_up() {
    this.fight_level++;
  }

  mlevel_up() {
    this.magic_level++;
  }

  use_move(victim) {
    if (this.types.has('magic')) {
      // could drain this.user's MP
    }
  }

}

window.Bleed = class Bleed extends Combat.StatusEffect {
  constructor(origin, level) {
    super(origin);
    this.level = level;
    this.counter = 0;
  }

  on_turn(character) {
    this.counter++;

    // bleeds for three turns
    if (this.counter < 3) {
      return new Combat.MoveResult(
        new Combat.Damage(['fighting'], 0),
        new Combat.Damage(['fighting'], this.level * 3),
        ["Bleeding did " + this.level * 3 + " damage"]
      );
    }
  }
}

window.Burn = class Burn extends Combat.StatusEffect {
  constructor(origin, level) {
    super(origin);
    this.level = level;
    this.counter = 0;
  }

  on_turn(character) {
    this.counter++;
    if (this.counter < 5) {
      return new Combat.MoveResult(
        new Combat.Damage(['magic'], 0),
        new Combat.Damage(['magic'], this.level * 3),
        ["Burning did " + this.level * 3 + " damage"],
      );
    }
  }
}

window.Punch = class extends ExampleMove {
  constructor(user) {
    super(user, ['fighting'], null);
    this.fight_level = 1;
    this.magic_level = 0;
    this.critical_chance = 0.5;
    this.bleed_chance = 0.9;
  }

  use_move() {
    var damage = this.user.level * (this.fight_level * 10 + this.magic_level);
    var description = [];
    var statuseffect = null;

    if (Math.random() < this.critical_chance) {
      damage += this.user.level * (this.fight_level * 5);
      description.push("Critical hit!");
    }
    description.push("Punch did " + damage + " damage!");

    if (Math.random() < this.bleed_chance) {
      statuseffect = new Bleed(this.user, this.user.level * this.fight_level);
      description.push("Punch caused bleeding!");
    }
    return new Combat.MoveResult(
      new Combat.Damage(this.types, 0),
      new Combat.Damage(this.types, damage, statuseffect),
      description,
    );
  }
}

window.Fireball = class extends ExampleMove {
  constructor(user) {
    super(user, ['magic'], null);
    this.fight_level = 0;
    this.magic_level = 1;
    this.critical_chance = 0.5;
    this.burn_chance = 0.5;
  }

  use_move() {
    var damage = this.user.level * (this.magic_level * 20 + this.fight_level);
    var description = [];
    var statuseffect = null;
    if (Math.random() < this.critical_chance) {
      damage += this.user.level * this.magic_level * 5;
      description.push("Critical hit!");
    }
    description.push("Fireball did " + damage + " damage!");

    if (Math.random() < this.burn_chance) {
      statuseffect = new Burn(this.user, this.user.level * this.magic_level);
      description.push("Fireball caused burning!");
    }

    return new Combat.MoveResult(
      new Combat.Damage(this.types, 0),
      new Combat.Damage(this.types, damage, statuseffect),
      description,
    );
  }
}


//(async function() {
//  console.log("waiting for sanic");
//  await Sonic.loaded;
//  console.log("waiting for assets");
//  console.log("Starting game");
//})();


window.Combat = Combat;
window.Sonic = Sonic;
window.game = game;
window.s = s;
window.ui = ui;
window.assets = assets;

var container = document.createElement("div");

var stats = document.createElement("pre");
container.appendChild(stats);

var text = document.createElement("pre");
container.appendChild(text);

var actions = document.createElement("div");
actions.style.display = "none";
container.appendChild(actions);

var punch = document.createElement("button");
punch.innerText = "punch";
actions.appendChild(punch);

var run = document.createElement("button");
run.innerText = "run";
actions.appendChild(run);

document.body.appendChild(container);

async function get_action() {
  actions.style.display = "";
  var resolver = null;
  var action_done = new Promise((r) => { resolver = r; });
  var selected_action = null;
  var click_handler = function(e) {
    resolver();
    selected_action = e.target.innerText;
  };

  punch.addEventListener('click', click_handler);
  run.addEventListener('click', click_handler);

  await action_done;
  punch.removeEventListener('click', click_handler);
  run.removeEventListener('click', click_handler);

  actions.style.display = "none";
  return selected_action;
}

function get_dragon(max_level) {
  var dragon = new Combat.Character("dragon", "blue", "magic");
  var level = Math.random();
  console.log("lvl", level);
  level *= (max_level - 1);
  console.log("   ", level);
  dragon.level = Math.round(level) + 1;
  dragon.moves.push(new Fireball(dragon));

  return dragon;
}

async function sleep(duration) {
  var resolver = null;
  var sleep_done = new Promise((r) => { resolver = r; });
  setTimeout(resolver, duration);
  await sleep_done;
}

function describe_effect(effect) {
  return effect.constructor.name + "(" + effect.level + ")";
}
(async function() {
  window.knight = new Combat.Character("knight", "green", "fighting");
  knight.moves.push(new Punch(knight));
  knight.level = 2;
  //window.knight = get_dragon();

  while(true) {
    text.innerText = "Encountered a ferocious dragon!\n";
    var dragon = get_dragon(knight.level + 1);

    var ran = false;
    var is_knight_turn = true;
    while(dragon.hp && knight.hp && (!ran)) {
      stats.innerText = "knight hp: " + knight.hp + " level: " + knight.level + "\n";
      stats.innerText += "knight status effects: " + knight.status_effects.map(describe_effect) + "\n";
      stats.innerText += "dragon hp: " + dragon.hp + " level: " + dragon.level + "\n";
      stats.innerText += "dragon status effects: " + dragon.status_effects.map(describe_effect) + "\n";

      if (is_knight_turn) {
        var to_delete = [];
        for (var idx in knight.status_effects) {
          console.log("running effect");
          var effect = knight.status_effects[idx];
          var result = effect.on_turn(knight)
          if (!result) {
            text.innerText += "Effect " + describe_effect(effect) + " ended.\n";
            to_delete.push(idx);
          } else {
            effect.origin.damage(result.dmg_to_self);
            knight.damage(result.dmg_to_enemy);
            text.innerText += result.description + "\n";
          }
        }
        var counter = 0;
        for (var idx of to_delete) {
          var del = idx + counter;
          knight.status_effects =
            knight.status_effects.slice(0, del).concat(knight.status_effects.slice(del + 1));
          counter++;
        }

        var action = await get_action();
        if (action == "run") {
          if (Math.random() < 0.25) {
            text.innerText += "Got away safely!\n";
            ran = true;
          } else {
            text.innerText += "Could not escape!\n";
          }
        } else {
          var result = knight.moves[0].use_move();
          knight.damage(result.dmg_to_self);
          dragon.damage(result.dmg_to_enemy);
          text.innerText += result.description + "\n";
        }
      } else {
        var to_delete = [];
        for (var idx in dragon.status_effects) {
          console.log("running effect");
          var effect = dragon.status_effects[idx];
          var result = effect.on_turn(dragon)
          if (!result) {
            text.innerText += "Effect " + describe_effect(effect) + " ended.\n";
            to_delete.push(idx);
          } else {
            effect.origin.damage(result.dmg_to_self);
            dragon.damage(result.dmg_to_enemy);
            text.innerText += result.description + "\n";
          }
        }
        var counter = 0;
        for (var idx of to_delete) {
          var del = idx + counter;
          dragon.status_effects =
            dragon.status_effects.slice(0, del).concat(dragon.status_effects.slice(del + 1));
          counter++;
        }
        await sleep(500);
        var result = dragon.moves[0].use_move();
        dragon.damage(result.dmg_to_self);
        knight.damage(result.dmg_to_enemy);
        text.innerText += result.description + "\n";
      }
      await sleep(500);
      is_knight_turn = !is_knight_turn;
    }

    if (!ran) {
      if (knight.hp) {
        text.innerText += "You won!\n";
        knight.level++;
        knight.status_effects = [];
        await sleep(1000);
      } else {
        text.innerText += "You died :(!\n";
        return;
      }
    }
  }
})();

</script>
<body>
</body>
